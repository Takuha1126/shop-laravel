version: 2.1

jobs:
  build:
    docker:
      - image: circleci/php:8.0-apache
        environment:
          PHP_EXTENSIONS: gd
          DB_CONNECTION: mysql
          DB_HOST: mysql
          DB_PORT: 3306
          DB_DATABASE: demo_test
          DB_USERNAME: root
          DB_PASSWORD: root
      - image: circleci/mysql:5.7
        environment:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: demo_test

    steps:
      - checkout

      - run:
          name: Install MySQL and PHP extensions
          command: |
            sudo apt-get update
            sudo apt-get install -y default-mysql-client libmariadb-dev
            sudo docker-php-ext-install pdo_mysql

      - run:
          name: Install gd extension and dependencies
          command: |
            sudo apt-get install -y libpng-dev libjpeg-dev libfreetype6-dev
            sudo docker-php-ext-configure gd --with-jpeg --with-freetype
            sudo docker-php-ext-install gd

      - run:
          name: Create .env.testing file
          command: |
            mkdir -p src
            cp src/.env.example src/.env.testing
            echo "APP_ENV=testing" >> src/.env.testing
            echo "APP_DEBUG=true" >> src/.env.testing
            echo "APP_KEY=base64:dummyKey=" >> src/.env.testing

      - run:
          name: Wait for MySQL to be ready
          command: |
            wget https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh
            chmod +x wait-for-it.sh
            ./wait-for-it.sh mysql:3306 -- echo "MySQL is up"

      - run:
          name: Install dependencies, configure environment, and run tests
          command: |
            cd src
            composer install --no-interaction --prefer-dist --optimize-autoloader

            # Ensure .env.testing is properly configured
            cp .env.testing .env
            php artisan key:generate --ansi

            # Update database configuration in .env
            sed -i "s/DB_CONNECTION=.*/DB_CONNECTION=mysql/" .env
            sed -i "s/DB_HOST=.*/DB_HOST=mysql/" .env
            sed -i "s/DB_DATABASE=.*/DB_DATABASE=demo_test/" .env
            sed -i "s/DB_USERNAME=.*/DB_USERNAME=root/" .env
            sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=root/" .env

            # Output current environment settings for debug
            echo "Current environment settings:"
            cat .env

            # Clear configuration cache, test MySQL connection, run migrations and tests
            php artisan config:clear
            php artisan migrate:fresh --seed --force
            vendor/bin/phpunit --env=testing

  deploy:
    docker:
      - image: circleci/php:8.0
    steps:
      - checkout

      - run:
          name: Add SSH key
          command: |
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -H ec2-52-197-124-165.ap-northeast-1.compute.amazonaws.com >> ~/.ssh/known_hosts

      - run:
          name: Deploy over SSH
          command: |
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ec2-user@ec2-52-197-124-165.ap-northeast-1.compute.amazonaws.com "\
              cd /var/www/shop-laravel && \
              git fetch origin && \
              git reset --hard origin/main && \
              cd src && \
              composer install --no-interaction --prefer-dist --optimize-autoloader && \
              php artisan migrate --force"

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
